<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script> <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --bg-color: #f8f9fc;
            --card-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: #5a5c69;
            overflow-x: hidden;
        }

        /* NAVBAR STYLING */
        .navbar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            padding: 15px 0;
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }
        .nav-link {
            font-weight: 500;
            color: #5a5c69 !important;
            margin-left: 15px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color) !important;
        }
        .btn-primary-custom {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50px;
            padding: 10px 30px;
            border: none;
            transition: transform 0.2s;
        }
        .btn-primary-custom:hover {
            transform: scale(1.05);
            background-color: #2e59d9;
        }

        /* SECTIONS & CARDS */
        .page-section {
            display: none;
            padding-top: 100px; /* Offset for fixed navbar */
            padding-bottom: 50px;
            animation: fadeIn 0.6s ease;
        }
        .active-section { display: block; }
        
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            background: white;
            transition: transform 0.3s;
        }
        .card-hover:hover {
            transform: translateY(-5px);
        }

        /* HERO SECTION */
        .hero-title { font-weight: 700; font-size: 3rem; color: #2e384d; }
        .hero-lead { font-size: 1.1rem; color: #858796; margin-bottom: 30px; }

        /* VIDEO CONTAINER */
        .video-wrapper {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: #000;
            position: relative;
        }
        .video-wrapper img { width: 100%; height: auto; display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-shield-lock-fill"></i> FaceAtt.</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link active" onclick="nav('home')" href="#">Home</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="nav('about')" href="#">Tentang</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="nav('scan')" href="#">Absen</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="nav('register')" href="#">Register</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="nav('data')" href="#">Data</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="nav('team')" href="#">Tim</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section id="home" class="page-section active-section">
        <div class="container">
            <div class="row align-items-center min-vh-75">
                <div class="col-lg-6">
                    <span class="badge bg-light text-primary mb-3 px-3 py-2 rounded-pill fw-bold">Versi 2.0 - AI Powered</span>
                    <h1 class="hero-title">Absensi Wajah <br> <span class="text-primary">Cepat & Akurat.</span></h1>
                    <p class="hero-lead">Tinggalkan cara lama. Sistem absensi berbasis kecerdasan buatan yang mendeteksi dan mengenali karyawan dalam hitungan detik.</p>
                    <button onclick="nav('scan')" class="btn btn-primary-custom shadow fw-bold"><i class="bi bi-camera-fill me-2"></i> Mulai Absen</button>
                    <button onclick="nav('about')" class="btn btn-outline-secondary rounded-pill px-4 py-2 ms-2 fw-bold">Pelajari Sistem</button>
                </div>
                <div class="col-lg-6 text-center mt-5 mt-lg-0">
                    <img src="https://img.freepik.com/free-vector/face-recognition-concept-illustration_114360-4592.jpg" alt="AI Illustration" class="img-fluid rounded-4 shadow-lg" style="max-height: 400px;">
                </div>
            </div>
            
            <div class="row mt-5">
                <div class="col-md-4">
                    <div class="card-custom p-4 text-center card-hover">
                        <i class="bi bi-lightning-charge-fill text-warning display-4"></i>
                        <h5 class="fw-bold mt-3">Real-time</h5>
                        <p class="small text-muted">Deteksi instan tanpa delay.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-custom p-4 text-center card-hover">
                        <i class="bi bi-check-circle-fill text-success display-4"></i>
                        <h5 class="fw-bold mt-3">Akurat</h5>
                        <p class="small text-muted">Menggunakan model VGG-Face.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-custom p-4 text-center card-hover">
                        <i class="bi bi-file-earmark-pdf-fill text-danger display-4"></i>
                        <h5 class="fw-bold mt-3">Laporan PDF</h5>
                        <p class="small text-muted">Unduh rekap kehadiran mudah.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="about" class="page-section">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">Bagaimana Sistem Bekerja?</h2>
                <p class="text-muted">Kombinasi dua algoritma komputer visi untuk performa maksimal.</p>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card-custom p-5 h-100">
                        <h3 class="fw-bold text-primary mb-3">1. Deteksi (Haar Cascade)</h3>
                        <p>Sistem menggunakan <b>Haar Cascade Classifier</b> dari OpenCV. Algoritma ini sangat cepat dan ringan untuk mendeteksi keberadaan wajah manusia dalam video stream, membuat kotak hijau (Bounding Box) di sekitar wajah.</p>
                        <hr>
                        <small class="text-muted"><i class="bi bi-check-circle-fill text-success"></i> Keunggulan: Sangat Cepat & Ringan.</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-custom p-5 h-100">
                        <h3 class="fw-bold text-danger mb-3">2. Pengenalan (DeepFace)</h3>
                        <p>Setelah wajah terdeteksi, sistem menggunakan <b>VGG-Face (Deep Learning)</b> untuk menganalisa fitur unik wajah dan membandingkannya dengan database karyawan. Ini memastikan akurasi tinggi dalam mengenali siapa orang tersebut.</p>
                        <hr>
                        <small class="text-muted"><i class="bi bi-check-circle-fill text-success"></i> Keunggulan: Akurasi Tinggi (97%+).</small>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="scan" class="page-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold m-0">üì∑ Scan Kehadiran</h3>
                        <span class="badge bg-danger animate-pulse">LIVE</span>
                    </div>
                    <div class="video-wrapper">
                        <img src="/video_feed" alt="Camera Feed">
                    </div>
                </div>
                
                <div class="col-lg-4 mt-4 mt-lg-0">
                    <div class="card-custom p-4 text-center h-100 d-flex flex-column justify-content-center">
                        <div class="mb-4">
                            <i class="bi bi-person-bounding-box display-1 text-primary"></i>
                        </div>
                        <h6 class="text-muted text-uppercase fw-bold ls-1">Status Pengenalan</h6>
                        <h2 id="lbl-status" class="fw-bold my-3">Menunggu...</h2>
                        
                        <div id="status-indicator" class="alert alert-secondary rounded-pill">
                            Silakan arahkan wajah
                        </div>

                        <hr class="my-4">

                        <div class="form-check form-switch d-flex justify-content-center align-items-center bg-light p-3 rounded-4">
                            <input class="form-check-input me-3" type="checkbox" id="voiceToggle" checked style="width: 3rem; height: 1.5rem;">
                            <label class="form-check-label fw-bold small" for="voiceToggle">Suara Asisten</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="register" class="page-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-5">
                    <div class="card-custom p-5">
                        <h3 class="fw-bold mb-4">üìù Registrasi Karyawan</h3>
                        <form onsubmit="event.preventDefault(); startRegister();">
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold text-uppercase">Nama Lengkap</label>
                                <input type="text" id="regName" class="form-control form-control-lg bg-light border-0" placeholder="Masukkan nama...">
                            </div>
                            <div class="alert alert-info small border-0 bg-info-subtle text-info-emphasis">
                                <i class="bi bi-info-circle-fill me-2"></i> Sistem akan mengambil <b>20 Foto</b> secara otomatis. Pastikan pencahayaan cukup.
                            </div>
                            <button type="submit" class="btn btn-primary-custom w-100 py-3 mt-2">
                                <i class="bi bi-save2-fill me-2"></i> Simpan & Scan Wajah
                            </button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-7 mt-4 mt-lg-0">
                    <div class="video-wrapper" style="height: 450px;">
                        <img src="/video_feed" style="height: 100%; object-fit: cover;">
                        <div class="position-absolute bottom-0 start-0 w-100 p-3 bg-gradient-dark text-white text-center" style="background: rgba(0,0,0,0.5);">
                            Preview Kamera
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="data" class="page-section">
        <div class="container">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
                <h3 class="fw-bold mb-3 mb-md-0">üìÇ Data Kehadiran</h3>
                <div class="d-flex gap-2">
                    <button onclick="downloadPDF()" class="btn btn-danger text-white rounded-pill px-4"><i class="bi bi-file-pdf-fill"></i> Download PDF</button>
                    <button onclick="hapusData()" class="btn btn-outline-danger rounded-pill px-4"><i class="bi bi-trash"></i> Hapus Semua</button>
                </div>
            </div>

            <div class="card-custom p-4">
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                            <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Cari nama karyawan...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <input type="date" id="dateInput" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <button onclick="resetFilter()" class="btn btn-secondary w-100">Reset Filter</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="absensiTable">
                        <thead class="table-light">
                            <tr>
                                <th class="py-3">No</th>
                                <th class="py-3">Nama Karyawan</th>
                                <th class="py-3">Waktu</th>
                                <th class="py-3">Tanggal</th>
                                <th class="py-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
                <p id="empty-msg" class="text-center text-muted mt-3" style="display:none;">Data tidak ditemukan.</p>
            </div>
        </div>
    </section>

    <section id="team" class="page-section">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">Tim Pengembang</h2>
                <p class="text-muted">Orang-orang dibalik sistem cerdas ini.</p>
            </div>
            <div class="row justify-content-center">
                <div class="col-md-4 mb-4">
                    <div class="card-custom p-4 text-center card-hover">
                        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" width="100" class="rounded-circle mb-3 shadow-sm">
                        <h5 class="fw-bold">Rangga Aditya Saputra</h5>
                        <p class="text-primary small fw-bold">NIM: 221230043</p>
                        <p class="small text-muted">Mahasiswa</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card-custom p-4 text-center card-hover">
                        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" width="100" class="rounded-circle mb-3 shadow-sm">
                        <h5 class="fw-bold">Dimas Nur Mi'Raj</h5>
                        <p class="text-primary small fw-bold">NIM: 221230053</p>
                        <p class="small text-muted">Mahasiswa</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card-custom p-4 text-center card-hover">
                        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" width="100" class="rounded-circle mb-3 shadow-sm">
                        <h5 class="fw-bold">Wega Ramadhan</h5>
                        <p class="text-primary small fw-bold">Nim:221230055</p>
                        <p class="small text-muted">Mahasiswa.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card-custom p-4 text-center card-hover">
                        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" width="100" class="rounded-circle mb-3 shadow-sm">
                        <h5 class="fw-bold">Ferdian Putra Wijaksono</h5>
                        <p class="text-primary small fw-bold">NIM: 221230045</p>
                        <p class="small text-muted">Mahasiswa.</p>
                    </div>
                </div
            </div>
        </div>
    </section>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- GLOBAL VARIABLES ---
        let allLogs = []; // Menyimpan semua data untuk filtering client-side
        let lastSpokenName = "";
        let isUnknownCooldown = false;

        // --- NAVIGATION LOGIC ---
        function nav(target) {
            $('.page-section').removeClass('active-section');
            $('#' + target).addClass('active-section');
            
            // Update Navbar Active State
            $('.nav-link').removeClass('active');
            // Mencari link yang onclick-nya mengandung target
            $(`.nav-link[onclick="nav('${target}')"]`).addClass('active');

            // Close navbar on mobile after click
            $('.navbar-collapse').collapse('hide');

            if(target === 'data') fetchLogs();
        }

        // --- FETCH & RENDER DATA ---
        function fetchLogs() {
            $.get('/get_logs', function(data) {
                // Backend mengembalikan JSON string atau Object
                // Kita parsing jika string
                allLogs = (typeof data === 'string') ? JSON.parse(data) : data;
                
                // Urutkan terbaru diatas
                allLogs.reverse(); 
                
                renderTable(allLogs);
            });
        }

        function renderTable(data) {
            let html = '';
            if(data.length === 0) {
                $('#table-body').html('');
                $('#empty-msg').show();
                return;
            }
            
            $('#empty-msg').hide();
            data.forEach((l, index) => {
                html += `<tr>
                    <td>${index + 1}</td>
                    <td class="fw-bold text-dark">${l.Nama}</td>
                    <td><span class="badge bg-primary-subtle text-primary rounded-pill px-3">${l.Waktu}</span></td>
                    <td>${l.Tanggal}</td>
                    <td><i class="bi bi-check-circle-fill text-success"></i> Hadir</td>
                </tr>`;
            });
            $('#table-body').html(html);
        }

        // --- FILTERING ---
        $('#searchInput, #dateInput').on('input change', function() {
            const keyword = $('#searchInput').val().toLowerCase();
            const dateVal = $('#dateInput').val();

            const filtered = allLogs.filter(item => {
                const matchName = item.Nama.toLowerCase().includes(keyword);
                const matchDate = dateVal ? item.Tanggal === dateVal : true;
                return matchName && matchDate;
            });

            renderTable(filtered);
        });

        function resetFilter() {
            $('#searchInput').val('');
            $('#dateInput').val('');
            renderTable(allLogs);
        }

        // --- DOWNLOAD PDF ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.text("Laporan Data Absensi", 14, 20);
            doc.setFontSize(10);
            doc.text("Dicetak pada: " + new Date().toLocaleString(), 14, 28);

            // Table Data Preparation
            // Kita ambil data dari allLogs yang saat ini tampil (jika mau sesuai filter, harus pakai var filtered)
            // Untuk simpelnya kita ambil allLogs
            const tableColumn = ["No", "Nama", "Waktu", "Tanggal"];
            const tableRows = [];

            allLogs.forEach((log, index) => {
                const logData = [index + 1, log.Nama, log.Waktu, log.Tanggal];
                tableRows.push(logData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 35,
                theme: 'grid',
                styles: { font: "helvetica", fontSize: 10 },
                headStyles: { fillColor: [78, 115, 223] } // Primary Color
            });

            doc.save("Laporan_Absensi.pdf");
        }

        // --- HAPUS DATA (Placeholder) ---
        function hapusData() {
            Swal.fire({
                title: 'Hapus Semua Data?',
                text: "Data absensi akan hilang permanen!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Panggil endpoint backend (Anda perlu menambahkan route ini di app.py)
                    $.post('/delete_all_logs', function(res){
                        if(res.status === 'success'){
                             Swal.fire('Terhapus!', 'Data absensi telah dibersihkan.', 'success');
                             fetchLogs();
                        } else {
                            // Fallback jika backend belum diupdate
                             Swal.fire('Gagal', 'Fitur ini memerlukan update pada file app.py (route /delete_all_logs)', 'error');
                        }
                    }).fail(function() {
                        Swal.fire('Error', 'Endpoint /delete_all_logs belum dibuat di app.py', 'error');
                    });
                }
            })
        }

        // --- REGISTER ---
        function startRegister() {
            const nama = $('#regName').val();
            if(!nama) { Swal.fire('Ops!', 'Nama tidak boleh kosong.', 'error'); return; }

            Swal.fire({
                title: 'Sedang Memindai...',
                html: 'Tahan posisi wajah.<br>Sistem mengambil 20 sampel foto.',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            $.post('/register_face', { nama: nama }, function(res) {
                if(res.status === 'success') {
                    Swal.fire('Berhasil!', res.message, 'success');
                    $('#regName').val('');
                } else {
                    Swal.fire('Gagal', res.message, 'error');
                }
            });
        }

        // --- VOICE ASSISTANT & REALTIME STATUS ---
        function speak(text) {
            if(!$('#voiceToggle').is(':checked')) return;
            const utt = new SpeechSynthesisUtterance(text);
            utt.lang = 'id-ID';
            utt.rate = 0.9;
            window.speechSynthesis.speak(utt);
        }

        setInterval(() => {
            if($('#scan').hasClass('active-section')) {
                $.get('/status_absensi', function(data) {
                    $('#lbl-status').text(data.message);
                    
                    // Style Updates
                    const box = $('#status-indicator');
                    box.removeClass('alert-secondary alert-success alert-danger alert-warning');
                    
                    if(data.color === 'success') box.addClass('alert-success');
                    else if(data.color === 'danger') box.addClass('alert-danger');
                    else if(data.color === 'warning') box.addClass('alert-warning');
                    else box.addClass('alert-secondary');
                    
                    box.text(data.message);

                    // Voice Logic
                    if (data.color === 'success') {
                        let name = data.message.replace("Hadir: ", "").replace("Sudah Absen: ", "").trim();
                        if (name !== lastSpokenName && name.length > 0) {
                            let firstName = name.split(' ')[0];
                            speak(`Selamat, anda sudah absen, ${firstName}`);
                            lastSpokenName = name;
                            setTimeout(() => { lastSpokenName = ""; }, 15000);
                        }
                    } else if (data.color === 'danger') {
                         if(!isUnknownCooldown) {
                             speak("Maaf, wajah anda belum terdaftar.");
                             lastSpokenName = "";
                             isUnknownCooldown = true;
                             setTimeout(() => { isUnknownCooldown = false; }, 6000);
                         }
                    }
                });
            }
        }, 1000);

        // Init
        nav('home');
    </script>
</body>
</html>